#include<iostream>
using namespace std;
#include<stdio.h>
#include<sys/types.h>
#include<stdlib.h>
#include<sys/stat.h>
#include<fcntl.h>
#include<error.h>
#include<wait.h>
#include<unistd.h>

int main()
{
	int i,r,p1,p2,fd[2];
	char buf[50],s[50];
	pipe(fd);
	while((p1=fork())==-1);
	if(p1==0)
	{
		lockf(fd[1],1,0);
		sprintf(buf,"child process P1 is sending messages!\t");
		printf("child process P1!\t");
		printf("PID=%d\n",p1);
		write(fd[1],buf,50);
		sleep(5);
		lockf(fd[1],0,0);
		exit(0);

	}
	else
	{
		while((p2=fork())==-1);
		if(p2==0)
		{
			lockf(fd[1],1,0);
			sprintf(buf,"child process P2 is sending messages!\t");
			printf("child process P2!\t");
			printf("PID=%d\n",p2);
			write(fd[1],buf,50);
			sleep(5);
			lockf(fd[1],0,0);
			exit(0);

		}
		wait(0);
		if(r=read(fd[0],s,50)==-1)
			printf("can't read pipe!\n");
		else printf("%s\n",s);printf("PID=%d\n",p1);
		wait(0);
		if(r=read(fd[0],s,50)==-1)
			printf("can't read pipe!\n");
		else printf("%s\n",s);printf("PID=%d\n",p2);
		exit(0);
	}

}